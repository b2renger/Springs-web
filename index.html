<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Interactive Springs</title>
  <style>
    html, body {
      padding: 0;
      margin: 0;
      overflow: hidden; /* Prevent scrollbars and bouncing */
      height: 100%;
      -webkit-font-smoothing: antialiased;
      background-color: #000; /* Match canvas background */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    /* UI Overlay Styles */
    #ui-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      /* Full width layout, no padding/gap */
      padding: 0;
      gap: 0;
      z-index: 10;
      pointer-events: none; 
      display: flex;
      flex-direction: row;
      align-items: flex-start;
    }

    /* Column Layout */
    .ui-column {
        display: flex;
        flex-direction: column;
        flex: 1; /* Equal thirds */
        min-width: 0;
        pointer-events: none;
    }

    /* Navigation Buttons */
    .nav-btn {
        pointer-events: auto;
        width: 100%;
        padding: 16px 4px; /* Taller touch target */
        margin: 0;
        
        /* Glass Style - Rectangular with borders */
        background: rgba(20, 20, 20, 0.4);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        
        /* Borders for separation */
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        border-right: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 0; 
        
        /* Text Style with Bloom */
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* Remove right border from last button to prevent double border or edge overflow */
    .ui-column:last-child .nav-btn {
        border-right: none;
    }

    .nav-btn:hover {
        background: rgba(40, 40, 40, 0.5);
        color: rgba(255, 255, 255, 1);
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
    }

    .nav-btn.active {
        background: rgba(60, 60, 60, 0.6);
        color: #fff;
        text-shadow: 0 0 15px rgba(255, 255, 255, 1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.05);
    }

    /* Panels */
    .ui-panel {
        pointer-events: auto;
        width: 100%;
        box-sizing: border-box;
        
        /* Glass Style */
        background: rgba(15, 15, 15, 0.65);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        
        display: flex;
        flex-direction: column;
        gap: 20px;
        
        /* Animation State */
        max-height: 0;
        padding: 0 15px; /* Horizontal padding always present, vertical animated */
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), 
                    padding 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
                    opacity 0.3s ease;
    }
    
    .ui-column:last-child .ui-panel {
        border-right: none;
    }
    
    .ui-panel.active {
        max-height: 60vh; /* Allow plenty of space */
        padding-top: 20px;
        padding-bottom: 20px;
        opacity: 1;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    /* Controls */
    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .control-col {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.8rem;
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.2);
      flex-grow: 1;
    }
    
    .value-display {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        font-family: monospace;
        text-shadow: 0 0 4px rgba(255, 255, 255, 0.1);
    }

    /* Inputs */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
      outline: none;
      margin-top: 6px;
      padding: 0;
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.05);
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); /* Strong bloom */
      transition: transform 0.1s;
    }
    input[type="range"]::-webkit-slider-thumb:active {
        transform: scale(1.2);
    }
    
    select {
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      width: 100%;
      outline: none;
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.3);
    }
    select:focus {
        border-color: rgba(255,255,255,0.5);
        background: rgba(255,255,255,0.1);
    }

    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #fff;
        margin: 0;
        cursor: pointer;
        filter: drop-shadow(0 0 4px rgba(255,255,255,0.6));
    }
    
    .disabled {
        opacity: 0.3;
        pointer-events: none;
        filter: blur(1px);
    }
    
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
</head>
<body>
  
  <div id="ui-container">
    <!-- Physics Column -->
    <div class="ui-column">
        <button class="nav-btn" data-target="panel-physics">Physics</button>
        <div id="panel-physics" class="ui-panel">
            <div class="control-col">
                <div class="control-row">
                    <label>Stiffness</label>
                    <span id="val-stiffness" class="value-display">0.2</span>
                </div>
                <input type="range" id="inp-stiffness" min="0.01" max="1.0" step="0.01" value="0.2">
            </div>
            <div class="control-col">
                <div class="control-row">
                    <label>Damping</label>
                    <span id="val-damping" class="value-display">0.92</span>
                </div>
                <input type="range" id="inp-damping" min="0.8" max="0.99" step="0.001" value="0.92">
            </div>
            <div class="control-col">
                <div class="control-row">
                    <label>Mass</label>
                    <span id="val-mass" class="value-display">20</span>
                </div>
                <input type="range" id="inp-mass" min="1" max="100" step="1" value="20">
            </div>
        </div>
    </div>

    <!-- Audio Column -->
    <div class="ui-column">
        <button class="nav-btn" data-target="panel-audio">Audio</button>
        <div id="panel-audio" class="ui-panel">
            <div class="control-col">
                <div class="control-row">
                    <label>Base Note</label>
                    <span id="val-baseNote" class="value-display">48</span>
                </div>
                <input type="range" id="inp-baseNote" min="36" max="72" step="1" value="48">
            </div>
            <div class="control-col">
                <label>Scale</label>
                <select id="inp-scale"></select>
            </div>
            <div class="control-col">
                <label>Waveform</label>
                <select id="inp-waveform">
                    <option value="sine">Sine</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Effects Column -->
    <div class="ui-column">
        <button class="nav-btn" data-target="panel-effects">Effects</button>
        <div id="panel-effects" class="ui-panel">
            <!-- Reverb -->
            <div class="control-col">
                <div class="checkbox-row">
                    <input type="checkbox" id="inp-reverb-enabled">
                    <label for="inp-reverb-enabled">Reverb</label>
                </div>
                <div id="grp-reverb-mix" class="control-col">
                    <div class="control-row">
                        <label>Mix</label>
                    </div>
                    <input type="range" id="inp-reverb-mix" min="0" max="1" step="0.01" value="0.5">
                </div>
            </div>
            
            <!-- Crunch -->
            <div class="control-col" style="margin-top: 10px;">
                <div class="checkbox-row">
                    <input type="checkbox" id="inp-crunch-enabled">
                    <label for="inp-crunch-enabled">Distortion</label>
                </div>
                <div id="grp-crunch-mix" class="control-col">
                    <div class="control-row">
                        <label>Mix</label>
                    </div>
                    <input type="range" id="inp-crunch-mix" min="0" max="1" step="0.01" value="0.5">
                </div>
            </div>
        </div>
    </div>
  </div>

  <main></main>
  <script>
    // @license
    // SPDX-License-Identifier: Apache-2.0

    // --- Configuration ---
    const NUM_BOBS = 8;
    const MIN_GAP = 5; // Minimum gap between bobs and from screen edge

    // --- Musical Scales ---
    const scales = {
        'Major': [0, 2, 4, 5, 7, 9, 11],
        'Natural Minor': [0, 2, 3, 5, 7, 8, 10],
        'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11],
        'Dorian': [0, 2, 3, 5, 7, 9, 10],
        'Mixolydian': [0, 2, 4, 5, 7, 9, 10],
        'Blues': [0, 3, 5, 6, 7, 10],
        'Phrygian': [0, 1, 3, 5, 7, 8, 10],
        'Pentatonic Major': [0, 2, 4, 7, 9],
        'Chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        'Whole Tone': [0, 2, 4, 6, 8, 10],
    };

    // --- Simulation Parameters ---
    const settings = {
        stiffness: 0.2,
        damping: 0.92,
        velocitySmoothing: 0.0,
        mass: 20,
        baseMidiNote: 48, // C3
        selectedScale: 'Major',
        oscillatorType: 'sine',
    };
    const effectSettings = {
        reverbEnabled: false,
        reverbMix: 0.5,
        reverbDecay: 3,
        crunchEnabled: false,
        crunchAmount: 0.4,
        crunchMix: 0.5,
    };

    // --- Global State ---
    let bobs = [];
    let springs = [];
    const draggedItems = new Map();
    let audioInitialized = false;
    let reverb, crunch, midCutFilter, compressor;

    // --- Classes ---

    // Represents a single oscillating bob (the circle)
    class Bob {
      constructor(x, y, freq, radius) {
        this.position = createVector(x, y);
        this.velocity = createVector(0, 0);
        this.smoothedVelocity = createVector(0, 0);
        this.acceleration = createVector(0, 0);
        this.mass = settings.mass;
        this.radius = radius;
        this.isDragging = false;
        this.isPinned = false;
        
        // --- Audio Setup ---
        this.osc = new p5.Oscillator(settings.oscillatorType);
        this.osc.freq(freq);
        this.osc.amp(0);
        
        // Connect to the effects chain
        this.osc.disconnect();
        this.osc.connect(crunch);
        
        this.osc.start();
      }

      applyForce(force) {
        let f = p5.Vector.div(force, this.mass);
        this.acceleration.add(f);
      }

      update() {
        if (this.isDragging || this.isPinned) {
          this.velocity.mult(0);
          this.smoothedVelocity.mult(0);
          this.acceleration.mult(0);
          return;
        }

        this.velocity.add(this.acceleration);
        this.velocity.mult(settings.damping); 

        const smoothingFactor = 1.0 - settings.velocitySmoothing;
        this.smoothedVelocity.lerp(this.velocity, smoothingFactor);
        
        this.position.add(this.smoothedVelocity); 
        this.acceleration.mult(0); 
      }

      display() {
        drawingContext.shadowBlur = 30;
        drawingContext.shadowColor = 'rgba(255, 255, 255, 0.5)';
        noStroke();
        fill(255,200);
        ellipse(this.position.x, this.position.y, this.radius * 1.7, this.radius * 1.7);
        drawingContext.shadowBlur = 0;
      }

      isOver(x, y) {
        return dist(x, y, this.position.x, this.position.y) < this.radius;
      }
    }

    class Spring {
      constructor(anchor, bob, restLength) {
        this.anchor = anchor; // p5.Vector
        this.bob = bob;       // Bob object
        this.restLength = restLength;
        this.stiffness = settings.stiffness;
      }

      update() {
        let displacement = this.bob.position.y - this.anchor.y;
        let stretch = displacement - this.restLength;
        let forceY = -1 * this.stiffness * stretch;
        this.bob.applyForce(createVector(0, forceY));
      }

      display() {
        fill(100);
        noStroke();
        ellipse(this.anchor.x, this.anchor.y, 10, 10);
        stroke(200, 150);
        strokeWeight(2);
        line(this.anchor.x, this.anchor.y, this.bob.position.x, this.bob.position.y);
      }
    }

    // --- P5.js Core Functions ---

    function setup() {
      createCanvas(windowWidth, windowHeight);
      
      // --- Audio Effects Setup ---
      crunch = new p5.Distortion();
      midCutFilter = new p5.Filter('peaking');
      reverb = new p5.Reverb();
      compressor = new p5.Compressor();
      
      compressor.threshold(-24);
      compressor.ratio(12);
      compressor.attack(0.003);
      compressor.release(0.25);

      midCutFilter.freq(900);
      midCutFilter.gain(-9);
      midCutFilter.res(1.5);

      crunch.disconnect();
      crunch.connect(midCutFilter);
      midCutFilter.disconnect();
      midCutFilter.connect(reverb);
      reverb.disconnect();
      reverb.connect(compressor);
      
      // Initialize effect states based on defaults
      reverb.set(effectSettings.reverbDecay);
      reverb.drywet(effectSettings.reverbEnabled ? effectSettings.reverbMix : 0);
      crunch.set(effectSettings.crunchAmount, 'none');
      crunch.drywet(effectSettings.crunchEnabled ? effectSettings.crunchMix : 0);

      setupSimulation(true);
      setupUI();
    }
    
    function draw() {
      background(0, 70);

      for (const spring of springs) {
        spring.update();
        const bob = spring.bob;
        const distance = abs(bob.position.y - spring.anchor.y);
        let normalizedDistance = map(distance, 0, height / 2, 0, 1);
        normalizedDistance = constrain(normalizedDistance, 0, 1);
        let volume = Math.pow(normalizedDistance, 1.5) * 0.35;
        
        if (bob.osc) {
            bob.osc.amp(volume, 0.05);
        }
      }

      for (const bob of bobs) {
        bob.update();
        bob.display();
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      setupSimulation(true); 
    }

    // --- UI Logic ---
    function setupUI() {
        const navBtns = document.querySelectorAll('.nav-btn');

        navBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = btn.getAttribute('data-target');
                const panel = document.getElementById(targetId);
                
                // Toggle independent state
                btn.classList.toggle('active');
                panel.classList.toggle('active');
            });
        });

        // --- Physics Controls ---
        const inpStiffness = document.getElementById('inp-stiffness');
        const valStiffness = document.getElementById('val-stiffness');
        inpStiffness.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.stiffness = val;
            valStiffness.innerText = val.toFixed(2);
            for(const spring of springs) spring.stiffness = val;
        });

        const inpDamping = document.getElementById('inp-damping');
        const valDamping = document.getElementById('val-damping');
        inpDamping.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.damping = val;
            valDamping.innerText = val.toFixed(3);
        });

        const inpMass = document.getElementById('inp-mass');
        const valMass = document.getElementById('val-mass');
        inpMass.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.mass = val;
            valMass.innerText = val;
            for(const bob of bobs) bob.mass = val;
        });

        // --- Audio Controls ---
        const inpBaseNote = document.getElementById('inp-baseNote');
        const valBaseNote = document.getElementById('val-baseNote');
        inpBaseNote.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            settings.baseMidiNote = val;
            valBaseNote.innerText = val;
            setupSimulation();
        });

        const inpScale = document.getElementById('inp-scale');
        for (const scaleName of Object.keys(scales)) {
            const opt = document.createElement('option');
            opt.value = scaleName;
            opt.innerText = scaleName;
            inpScale.appendChild(opt);
        }
        inpScale.value = settings.selectedScale;
        inpScale.addEventListener('change', (e) => {
            settings.selectedScale = e.target.value;
            setupSimulation();
        });

        const inpWaveform = document.getElementById('inp-waveform');
        inpWaveform.value = settings.oscillatorType;
        inpWaveform.addEventListener('change', (e) => {
            settings.oscillatorType = e.target.value;
             for (const bob of bobs) {
                if (bob.osc) bob.osc.setType(settings.oscillatorType);
            }
        });

        // --- Effects Controls ---
        
        // Reverb
        const chkReverb = document.getElementById('inp-reverb-enabled');
        const grpReverbMix = document.getElementById('grp-reverb-mix');
        const inpReverbMix = document.getElementById('inp-reverb-mix');
        
        chkReverb.checked = effectSettings.reverbEnabled;
        if (!effectSettings.reverbEnabled) grpReverbMix.classList.add('disabled');

        chkReverb.addEventListener('change', (e) => {
            effectSettings.reverbEnabled = e.target.checked;
            reverb.drywet(effectSettings.reverbEnabled ? effectSettings.reverbMix : 0);
            if(e.target.checked) grpReverbMix.classList.remove('disabled');
            else grpReverbMix.classList.add('disabled');
        });

        inpReverbMix.value = effectSettings.reverbMix;
        inpReverbMix.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            effectSettings.reverbMix = val;
            if (effectSettings.reverbEnabled) reverb.drywet(val);
        });

        // Crunch
        const chkCrunch = document.getElementById('inp-crunch-enabled');
        const grpCrunchMix = document.getElementById('grp-crunch-mix');
        const inpCrunchMix = document.getElementById('inp-crunch-mix');

        chkCrunch.checked = effectSettings.crunchEnabled;
        if (!effectSettings.crunchEnabled) grpCrunchMix.classList.add('disabled');

        chkCrunch.addEventListener('change', (e) => {
            effectSettings.crunchEnabled = e.target.checked;
            crunch.drywet(effectSettings.crunchEnabled ? effectSettings.crunchMix : 0);
            if(e.target.checked) grpCrunchMix.classList.remove('disabled');
            else grpCrunchMix.classList.add('disabled');
        });

        inpCrunchMix.value = effectSettings.crunchMix;
        inpCrunchMix.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            effectSettings.crunchMix = val;
            if (effectSettings.crunchEnabled) crunch.drywet(val);
        });
    }

    
    // --- Input Handling ---

    function startAudio() {
        if (!audioInitialized && getAudioContext().state !== 'running') {
            userStartAudio();
            audioInitialized = true;
        }
    }

    function startDrag(x, y, id) {
      for (let i = bobs.length - 1; i >= 0; i--) {
        const bob = bobs[i];
        if (bob.isOver(x, y) && !draggedItems.has(id)) {
          bob.isDragging = true;
          bob.isPinned = false; 
          bob.position.y = y;
          draggedItems.set(id, { bob: bob, lastX: x, lastY: y });
          return true;
        }
      }
      return false;
    }

    function moveDrag(x, y, id) {
        const item = draggedItems.get(id);
        if (item) {
            item.lastX = x;
            item.lastY = y;
            item.bob.position.y = y;
        }
    }

    function endDrag(id) {
        const item = draggedItems.get(id);
        if (item) {
            const { bob, lastX, lastY } = item;
            const d = dist(lastX, lastY, bob.position.x, bob.position.y);
            
            if (d > bob.radius) {
                bob.isPinned = true;
            } else {
                bob.isPinned = false;
            }
            
            bob.isDragging = false;
            draggedItems.delete(id);
        }
    }

    // --- Mouse/Touch Helpers to block p5 canvas interaction if UI is touched ---

    function mousePressed(event) {
      // Check if clicking inside UI elements (buttons or panels)
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) return;

      startAudio();
      startDrag(mouseX, mouseY, 'mouse');
      return false;
    }

    function mouseDragged(event) {
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) return;
      moveDrag(mouseX, mouseY, 'mouse');
      return false;
    }

    function mouseReleased(event) {
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) return;
      endDrag('mouse');
      return false;
    }

    function touchStarted(event) {
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) {
        return true; // allow default UI interaction
      }

      startAudio();
      
      let bobWasGrabbed = false;
      for (const touch of touches) {
        if (startDrag(touch.x, touch.y, touch.id)) {
          bobWasGrabbed = true;
        }
      }
      
      return !bobWasGrabbed;
    }

    function touchMoved(event) {
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) {
        return true;
      }
      
      let isDraggingBob = false;
      for (const touch of touches) {
        if (draggedItems.has(touch.id)) {
            moveDrag(touch.x, touch.y, touch.id);
            isDraggingBob = true;
        }
      }
      
      return !isDraggingBob;
    }

    function touchEnded(event) {
      if (event && event.target && (event.target.closest('.nav-btn') || event.target.closest('.ui-panel'))) {
        return true;
      }
      
      let aDragHasEnded = false;
      const currentTouchIds = new Set(touches.map(t => t.id));
      const idsToEnd = [];

      for (const id of draggedItems.keys()) {
          if (id !== 'mouse' && !currentTouchIds.has(id)) {
              idsToEnd.push(id);
          }
      }
      
      if (idsToEnd.length > 0) {
        aDragHasEnded = true;
        idsToEnd.forEach(id => endDrag(id));
      }

      return !aDragHasEnded;
    }

    // --- Initialization & Updates ---
    
    function setupSimulation(resetPhysics = false) {
      const scaleIntervals = scales[settings.selectedScale];
      const numIntervals = scaleIntervals.length;

      const getFrequencyForIndex = (index) => {
        const octave = Math.floor(index / numIntervals);
        const noteInScale = index % numIntervals;
        const interval = scaleIntervals[noteInScale];
        const midiNote = settings.baseMidiNote + (octave * 12) + interval;
        return midiToFreq(midiNote);
      };

      if (resetPhysics) {
        for (const bob of bobs) {
          if (bob.osc) {
            bob.osc.disconnect();
            bob.osc.stop();
          }
        }
        
        bobs = [];
        springs = [];
        draggedItems.clear();

        const totalGaps = NUM_BOBS + 1;
        const availableWidthForBobs = width - (totalGaps * MIN_GAP);
        const bobDiameter = availableWidthForBobs / NUM_BOBS;
        const bobRadius = Math.max(5, (bobDiameter * 0.75) / 2);

        for (let i = 0; i < NUM_BOBS; i++) {
          const x = MIN_GAP + bobRadius + i * (bobDiameter + MIN_GAP);
          const anchorY = height / 2;
          const freq = getFrequencyForIndex(i);

          let bob = new Bob(x, anchorY, freq, bobRadius);
          bobs.push(bob);

          let anchor = createVector(x, anchorY);
          let spring = new Spring(anchor, bob, 0);
          springs.push(spring);
        }
      } else { 
        if (bobs.length === 0) return;
        for (let i = 0; i < bobs.length; i++) {
          const freq = getFrequencyForIndex(i);
          if (bobs[i].osc) {
            bobs[i].osc.freq(freq);
          }
        }
      }
    }
  </script>
</body>
</html>